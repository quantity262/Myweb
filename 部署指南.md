# 网站部署指南

本指南将帮助你将网站部署到服务器，让其他人也能访问。

## 方案一：云服务器部署（推荐）

### 1. 购买云服务器

推荐服务商：
- **阿里云**：https://www.aliyun.com
- **腾讯云**：https://cloud.tencent.com
- **华为云**：https://www.huaweicloud.com

**最低配置建议**：
- CPU: 1核
- 内存: 2GB
- 带宽: 1-3Mbps
- 系统: Ubuntu 20.04 LTS 或 CentOS 7

### 2. 连接服务器

使用 SSH 工具连接服务器（Windows 可使用 PuTTY 或 PowerShell）：

```bash
ssh root@你的服务器IP
```

### 3. 安装必要软件

#### 安装 Node.js

```bash
# Ubuntu/Debian
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs

# CentOS
curl -fsSL https://rpm.nodesource.com/setup_18.x | sudo bash -
sudo yum install -y nodejs

# 验证安装
node -v
npm -v
```

#### 安装 MySQL

```bash
# Ubuntu/Debian
sudo apt-get update
sudo apt-get install mysql-server

# CentOS
sudo yum install mysql-server

# 启动 MySQL
sudo systemctl start mysql
sudo systemctl enable mysql

# 设置 MySQL root 密码（替换为你的密码）
sudo mysql_secure_installation
```

#### 安装 PM2（进程管理器，用于保持服务运行）

```bash
sudo npm install -g pm2
```

### 4. 上传项目文件

#### 方法一：使用 Git（推荐）

```bash
# 在服务器上
cd /var/www
git clone 你的Git仓库地址
cd MyWeb
```

#### 方法二：使用 FTP/SFTP 工具

- Windows: WinSCP, FileZilla
- 将项目文件上传到服务器（如 `/var/www/MyWeb`）

### 5. 配置项目

```bash
# 进入项目目录
cd /var/www/MyWeb

# 安装依赖
npm install

# 创建 .env 文件
nano .env
```

`.env` 文件内容：

```env
DB_HOST=localhost
DB_USER=root
DB_PASSWORD=你的MySQL密码
DB_NAME=MyWeb
JWT_SECRET=你的随机密钥（建议使用长随机字符串）
PORT=3000
```

### 6. 初始化数据库

```bash
# 初始化数据库
npm run init-db
```

### 7. 配置防火墙

```bash
# Ubuntu/Debian (ufw)
sudo ufw allow 3000/tcp
sudo ufw enable

# CentOS (firewalld)
sudo firewall-cmd --permanent --add-port=3000/tcp
sudo firewall-cmd --reload
```

### 8. 启动服务

```bash
# 使用 PM2 启动（推荐，服务会自动重启）
pm2 start server.js --name myweb

# 设置开机自启
pm2 startup
pm2 save

# 查看服务状态
pm2 status
pm2 logs myweb
```

### 9. 配置域名（可选）

如果你有域名，可以配置 Nginx 反向代理：

#### 安装 Nginx

```bash
# Ubuntu/Debian
sudo apt-get install nginx

# CentOS
sudo yum install nginx
```

#### 配置 Nginx

```bash
sudo nano /etc/nginx/sites-available/myweb
```

添加以下配置：

```nginx
server {
    listen 80;
    server_name 你的域名.com;  # 或服务器IP

    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
```

```bash
# 创建软链接
sudo ln -s /etc/nginx/sites-available/myweb /etc/nginx/sites-enabled/

# 测试配置
sudo nginx -t

# 重启 Nginx
sudo systemctl restart nginx
```

### 10. 访问网站

- 直接访问：`http://你的服务器IP:3000`
- 如果配置了域名：`http://你的域名.com`

---

## 方案二：内网穿透（临时测试）

如果你只是想临时让别人访问，可以使用内网穿透工具。

> 📖 **详细指南**: 查看 [内网穿透详细指南.md](./内网穿透详细指南.md) 了解多种内网穿透工具的详细使用方法

### 快速开始（ngrok）

1. 注册账号：https://ngrok.com
2. 下载 ngrok
3. 配置认证令牌
4. 运行：

```bash
# Windows PowerShell
.\ngrok.exe http 3000
```

会得到一个公网地址，如：`https://xxxx.ngrok.io`

### 其他工具

- **cpolar**（国内推荐）：https://www.cpolar.com
- **natapp**：https://natapp.cn
- **frp**（自建服务器）：需要一台有公网IP的服务器

---

## 方案三：免费托管平台

### Vercel / Netlify（仅前端）

这些平台主要支持静态网站，你的项目有 Node.js 后端，需要：

1. 将前端和后端分离
2. 前端部署到 Vercel/Netlify
3. 后端部署到云服务器或 Railway/Render

### Railway / Render（全栈）

- **Railway**: https://railway.app
- **Render**: https://render.com

这些平台支持 Node.js + MySQL，但需要：
1. 将项目推送到 GitHub
2. 连接 GitHub 仓库到平台
3. 配置环境变量
4. 使用平台提供的 MySQL 数据库

---

## 方案四：本地服务器（有公网IP）

如果你有公网IP，可以直接在本地运行：

1. 确保防火墙开放 3000 端口
2. 配置路由器端口转发（将公网IP:3000 转发到内网IP:3000）
3. 直接访问：`http://你的公网IP:3000`

---

## 安全建议

1. **修改默认密码**：不要使用默认的 admin/admin123
2. **使用 HTTPS**：配置 SSL 证书（Let's Encrypt 免费）
3. **定期备份**：备份数据库和代码
4. **更新依赖**：定期运行 `npm audit` 检查安全漏洞
5. **限制访问**：使用防火墙限制不必要的端口

---

## 常见问题

### 1. 端口被占用

```bash
# 查看端口占用
netstat -tulpn | grep 3000

# 或修改 .env 中的 PORT
```

### 2. MySQL 连接失败

- 检查 MySQL 服务是否运行：`sudo systemctl status mysql`
- 检查防火墙是否开放 3306 端口
- 检查 MySQL 用户权限

### 3. PM2 服务无法启动

```bash
# 查看日志
pm2 logs myweb

# 重启服务
pm2 restart myweb
```

### 4. 静态文件无法访问

确保 `server.js` 中正确配置了静态文件路径。

---

## 推荐方案

- **个人项目/学习**：内网穿透（ngrok）或免费平台（Railway）
- **正式项目**：云服务器 + PM2 + Nginx
- **企业项目**：云服务器 + Docker + 负载均衡

---

## 快速部署脚本

创建 `deploy.sh`：

```bash
#!/bin/bash
echo "开始部署..."

# 安装依赖
npm install

# 初始化数据库
npm run init-db

# 使用 PM2 启动
pm2 start server.js --name myweb

echo "部署完成！"
echo "访问地址: http://你的服务器IP:3000"
```

运行：`chmod +x deploy.sh && ./deploy.sh`

